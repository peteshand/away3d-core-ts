<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../src/away/lights/shadowmaps/DirectionalShadowMapper.ts</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/away.base.Geometry.html">away.base.Geometry</a></li>
            
                <li><a href="../classes/away.base.Object3D.html">away.base.Object3D</a></li>
            
                <li><a href="../classes/away.base.SkinnedSubGeometry.html">away.base.SkinnedSubGeometry</a></li>
            
                <li><a href="../classes/away.base.SubGeometry.html">away.base.SubGeometry</a></li>
            
                <li><a href="../classes/away.base.SubGeometryBase.html">away.base.SubGeometryBase</a></li>
            
                <li><a href="../classes/away.events.AssetEvent.html">away.events.AssetEvent</a></li>
            
                <li><a href="../classes/away.events.CameraEvent.html">away.events.CameraEvent</a></li>
            
                <li><a href="../classes/away.events.Event.html">away.events.Event</a></li>
            
                <li><a href="../classes/away.events.EventDispatcher.html">away.events.EventDispatcher</a></li>
            
                <li><a href="../classes/away.events.GeometryEvent.html">away.events.GeometryEvent</a></li>
            
                <li><a href="../classes/away.events.HTTPStatusEvent.html">away.events.HTTPStatusEvent</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/away.base.html">away.base</a></li>
            
                <li><a href="../modules/away.events.html">away.events</a></li>
            
                <li><a href="../modules/away.geom.html">away.geom</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: ../src/away/lights/shadowmaps/DirectionalShadowMapper.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * ...
 * @author Gary Paluk - http://www.plugin.io
 */

///&lt;reference path=&quot;../../_definitions.ts&quot; /&gt;

module away.lights
{
	export class DirectionalShadowMapper extends away.lights.ShadowMapperBase
	{
		
		public _pOverallDepthCamera:away.cameras.Camera3D;
		public _pLocalFrustum:number[];
		
		public _pLightOffset:number = 10000;
		public _pMatrix:away.geom.Matrix3D;
		public _pOverallDepthLens:away.cameras.FreeMatrixLens;
		public _pSnap:number = 64;
		
		public _pCullPlanes:away.math.Plane3D[];
		public _pMinZ:number;
		public _pMaxZ:number;
		
		constructor()
		{
			super();
			this._pCullPlanes = [];
			this._pOverallDepthLens = new away.cameras.FreeMatrixLens();
			this._pOverallDepthCamera = new away.cameras.Camera3D( this._pOverallDepthLens );
			this._pLocalFrustum = [];
			this._pMatrix = new away.geom.Matrix3D();
		}
		
		public get snap():number
		{
			return this._pSnap;
		}
		
		public set snap( value:number )
		{
			this._pSnap = value;
		}
		
		public get lightOffset():number
		{
			return this._pLightOffset;
		}
		
		public set lightOffset( value:number )
		{
			this._pLightOffset = value;
		}
		
		//@arcane
		public get iDepthProjection():away.geom.Matrix3D
		{
			return this._pOverallDepthCamera.viewProjection;
		}
		
		//@arcane
		public get depth():number
		{
			return this._pMaxZ - this._pMinZ;
		}
		
		//@override
		public pDrawDepthMap( target:away.display3D.TextureBase, scene:away.containers.Scene3D, renderer:away.render.DepthRenderer )
		{
			this._pCasterCollector.camera = this._pOverallDepthCamera;
			this._pCasterCollector.cullPlanes = this._pCullPlanes;
			this._pCasterCollector.clear();
			scene.traversePartitions( this._pCasterCollector);
			renderer.iRender( this._pCasterCollector, target);
			this._pCasterCollector.cleanUp();
		}

		//@protected
		public pUpdateCullPlanes( viewCamera:away.cameras.Camera3D )
		{
			var lightFrustumPlanes:away.math.Plane3D[] = this._pOverallDepthCamera.frustumPlanes;
			var viewFrustumPlanes:away.math.Plane3D[] = viewCamera.frustumPlanes;
			this._pCullPlanes.length = 4;
			
			this._pCullPlanes[0] = lightFrustumPlanes[0];
			this._pCullPlanes[1] = lightFrustumPlanes[1];
			this._pCullPlanes[2] = lightFrustumPlanes[2];
			this._pCullPlanes[3] = lightFrustumPlanes[3];
			
			var light:away.lights.DirectionalLight = &lt;away.lights.DirectionalLight&gt; this._pLight;
			var dir:away.geom.Vector3D = light.sceneDirection;
			var dirX:number = dir.x;
			var dirY:number = dir.y;
			var dirZ:number = dir.z;
			var j:number = 4;
			for (var i:number = 0; i &lt; 6; ++i)
			{
				var plane:away.math.Plane3D = viewFrustumPlanes[i];
				if( plane.a*dirX + plane.b*dirY + plane.c*dirZ &lt; 0 )
				{
					this._pCullPlanes[j++] = plane;
				}
			}
		}
		
		//@override
		public pUpdateDepthProjection( viewCamera:away.cameras.Camera3D )
		{
			this.pUpdateProjectionFromFrustumCorners( viewCamera, viewCamera.lens.frustumCorners, this._pMatrix );
			this._pOverallDepthLens.matrix = this._pMatrix;
			this.pUpdateCullPlanes( viewCamera );
		}
		
		public pUpdateProjectionFromFrustumCorners(viewCamera:away.cameras.Camera3D, corners:number[], matrix:away.geom.Matrix3D )
		{
			var raw:number[] = [];
			var dir:away.geom.Vector3D;
			var x:number, y:number, z:number;
			var minX:number, minY:number;
			var maxX:number, maxY:number;
			var i:number;
			
			var light: away.lights.DirectionalLight = &lt;away.lights.DirectionalLight&gt; this._pLight;
			dir = light.sceneDirection;
			this._pOverallDepthCamera.transform = this._pLight.sceneTransform;
			x = Math.floor((viewCamera.x - dir.x*this._pLightOffset)/this._pSnap)*this._pSnap;
			y = Math.floor((viewCamera.y - dir.y*this._pLightOffset)/this._pSnap)*this._pSnap;
			z = Math.floor((viewCamera.z - dir.z*this._pLightOffset)/this._pSnap)*this._pSnap;
			this._pOverallDepthCamera.x = x;
			this._pOverallDepthCamera.y = y;
			this._pOverallDepthCamera.z = z;
			
			this._pMatrix.copyFrom( this._pOverallDepthCamera.inverseSceneTransform );
			this._pMatrix.prepend( viewCamera.sceneTransform );
			this._pMatrix.transformVectors( corners, this._pLocalFrustum );
			
			minX = maxX = this._pLocalFrustum[0];
			minY = maxY = this._pLocalFrustum[1];
			this._pMaxZ = this._pLocalFrustum[2];
			
			i = 3;
			while (i &lt; 24) {
				x = this._pLocalFrustum[i];
				y = this._pLocalFrustum[i + 1];
				z = this._pLocalFrustum[i + 2];
				if (x &lt; minX)
					minX = x;
				if (x &gt; maxX)
					maxX = x;
				if (y &lt; minY)
					minY = y;
				if (y &gt; maxY)
					maxY = y;
				if (z &gt; this._pMaxZ)
					this._pMaxZ = z;
				i += 3;
			}
			this._pMinZ = 1;
			
			var w:number = maxX - minX;
			var h:number = maxY - minY;
			var d:number = 1/(this._pMaxZ - this._pMinZ);
			
			if( minX &lt; 0 )
			{
				minX -= this._pSnap; // because int() rounds up for &lt; 0
			}
			if( minY &lt; 0 )
			{
				minY -= this._pSnap;
			}
			minX = Math.floor(minX/this._pSnap)*this._pSnap;
			minY = Math.floor(minY/this._pSnap)*this._pSnap;
			
			var snap2:number = 2*this._pSnap;
			w = Math.floor(w/snap2 + 2)*snap2;
			h = Math.floor(h/snap2 + 2)*snap2;
			
			maxX = minX + w;
			maxY = minY + h;
			
			w = 1/w;
			h = 1/h;
			
			raw[0] = 2*w;
			raw[5] = 2*h;
			raw[10] = d;
			raw[12] = -(maxX + minX)*w;
			raw[13] = -(maxY + minY)*h;
			raw[14] = -this._pMinZ*d;
			raw[15] = 1;
			raw[1] = raw[2] = raw[3] = raw[4] = raw[6] = raw[7] = raw[8] = raw[9] = raw[11] = 0;
			
			matrix.copyRawDataFrom(raw);
		}
	}
}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
